<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.stock.premium.mapper.StockPriceRecordMapper">

    <!-- 根据股票代码和日期查询价格记录 -->
    <select id="selectByStockCodeAndDate" resultType="com.stock.premium.entity.StockPriceRecord">
        SELECT id, stock_code, market_type, current_price, open_price, high_price, low_price, 
               pre_close_price, volume, turnover, change_rate, record_time, trade_date, 
               data_source, created_time
        FROM stock_price_record
        WHERE stock_code = #{stockCode} AND trade_date = #{tradeDate}
        ORDER BY record_time DESC
    </select>

    <!-- 查询指定日期的最新价格记录 -->
    <select id="selectLatestByDate" resultType="com.stock.premium.entity.StockPriceRecord">
        SELECT id, stock_code, market_type, current_price, open_price, high_price, low_price, 
               pre_close_price, volume, turnover, change_rate, record_time, trade_date, 
               data_source, created_time
        FROM stock_price_record
        WHERE trade_date = #{tradeDate}
        AND record_time = (
            SELECT MAX(record_time) 
            FROM stock_price_record 
            WHERE stock_code = stock_price_record.stock_code 
            AND trade_date = #{tradeDate}
        )
        ORDER BY stock_code
    </select>

</mapper>